{% extends "base.html" %}

{% block title %}{{ protocol.name }} - Details{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Botão de Voltar -->
    <div class="row mb-3">
        <div class="col-12">
            <button onclick="history.back()" class="btn btn-outline-secondary btn-back">
                <i class="fas fa-arrow-left me-2"></i>Back
            </button>
        </div>
    </div>
    
    <!-- Header do Protocolo -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h2 class="mb-2">
                                {{ protocol.name }}
                                {% if protocol.status.value == 'ativo' %}
                                    <span class="badge bg-success">Ativo</span>
                                {% else %}
                                    <span class="badge bg-danger">Encerrado</span>
                                {% endif %}
                            </h2>
                            <p class="text-muted mb-1">
                                <i class="fas fa-network-wired"></i> {{ protocol.network }}
                            </p>
                            {% if protocol.start_date %}
                                <p class="text-muted mb-1">
                                    <i class="fas fa-calendar"></i> Iniciado em {{ protocol.start_date.strftime('%d/%m/%Y') }}
                                </p>
                            {% endif %}
                            {% if protocol.daily_missions %}
                                <span class="badge bg-info">
                                    <i class="fas fa-clock"></i> Missões Diárias
                                </span>
                            {% endif %}
                        </div>
                        <div class="text-end">
                            <p class="h4 text-primary mb-1">
                                ${{ "{:.2f}".format(protocol.get_total_investment()) }}
                            </p>
                            <small class="text-muted">Total Investment</small>
                            {% set airdrop_value = protocol.get_total_airdrop_value() %}
                            {% if airdrop_value > 0 %}
                                <p class="h5 text-success mb-1 mt-2">
                                    ${{ "{:.2f}".format(airdrop_value) }}
                                </p>
                                <small class="text-muted">Airdrops Received</small>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Links e Ações -->
                    <div class="mt-3">
                        {% if protocol.website %}
                            <a href="{{ protocol.website }}" target="_blank" class="btn btn-outline-primary btn-sm me-2">
                                <i class="fas fa-globe"></i> Website
                            </a>
                        {% endif %}
                        {% if protocol.twitter %}
                            <a href="https://twitter.com/{{ protocol.twitter }}" target="_blank" class="btn btn-outline-info btn-sm me-2">
                                <i class="fab fa-twitter"></i> Twitter
                            </a>
                        {% endif %}
                        <form method="POST" action="{{ url_for('toggle_protocol_status', protocol_id=protocol.id) }}" class="d-inline">
                            {% if protocol.status.value == 'ativo' %}
                                <button type="submit" class="btn btn-outline-warning btn-sm" onclick="return confirm('Mark protocol as completed?')">
                                    <i class="fas fa-stop"></i> Complete
                                </button>
                            {% else %}
                                <button type="submit" class="btn btn-outline-success btn-sm" onclick="return confirm('Reactivate protocol?')">
                                    <i class="fas fa-play"></i> Reactivate
                                </button>
                            {% endif %}
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Abas de Navegação -->
    <ul class="nav nav-tabs" id="protocolTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="investments-tab" data-bs-toggle="tab" data-bs-target="#investments" type="button" role="tab">
                <i class="fas fa-dollar-sign"></i> Investments ({{ investments|length }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button" role="tab">
                <i class="fas fa-tasks"></i> Tasks ({{ tasks|length }})
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="airdrops-tab" data-bs-toggle="tab" data-bs-target="#airdrops" type="button" role="tab">
                <i class="fas fa-gift"></i> Airdrops ({{ protocol.airdrops|length }})
            </button>
        </li>
    </ul>

    <!-- Conteúdo das Abas -->
    <div class="tab-content" id="protocolTabsContent">
        
        <!-- Investments Tab -->
        <div class="tab-pane fade show active" id="investments" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Investments</h5>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addInvestmentModal">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>
                <div class="card-body">
                    {% if investments %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>Description</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for investment in investments %}
                                        <tr>
                                            <td>{{ investment.date.strftime('%d/%m/%Y') }}</td>
                                            <td>
                                                                                            {% if investment.type.value == 'entrada' %}
                                                <span class="badge bg-success">Entry</span>
                                            {% else %}
                                                <span class="badge bg-danger">Withdrawal</span>
                                            {% endif %}
                                            </td>
                                            <td>${{ "{:.2f}".format(investment.amount) }}</td>
                                            <td>{{ investment.description or '-' }}</td>
                                            <td>
                                                <a href="{{ url_for('edit_investment', investment_id=investment.id) }}" class="btn btn-outline-warning btn-sm">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <form method="POST" action="{{ url_for('delete_investment', investment_id=investment.id) }}" class="d-inline">
                                                    <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Delete investment?')">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted text-center py-4">No investments recorded yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Aba Tasks -->
        <div class="tab-pane fade" id="tasks" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Tasks</h5>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>
                <div class="card-body">
                    {% if tasks %}
                        <div class="row">
                            {% for task in tasks %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="card h-100 {% if task.status.value == 'concluida' %}border-success{% endif %}">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h6 class="card-title">{{ task.title }}</h6>
                                                {% if task.status.value == 'concluida' %}
                                                    <span class="badge bg-success">Completa</span>
                                                {% else %}
                                                    <span class="badge bg-warning">Pendente</span>
                                                {% endif %}
                                            </div>
                                            <p class="card-text small">{{ task.description or 'Sem descrição' }}</p>
                                            {% if task.completed_at %}
                                                <small class="text-muted">Concluída em {{ task.completed_at.strftime('%d/%m/%Y') }}</small>
                                            {% endif %}
                                            <div class="mt-2">
                                                <form method="POST" action="{{ url_for('toggle_task', task_id=task.id) }}" class="d-inline">
                                                    {% if task.status.value == 'concluida' %}
                                                        <button type="submit" class="btn btn-outline-warning btn-sm">
                                                            <i class="fas fa-undo"></i> Reabrir
                                                        </button>
                                                    {% else %}
                                                        <button type="submit" class="btn btn-outline-success btn-sm">
                                                            <i class="fas fa-check"></i> Concluir
                                                        </button>
                                                    {% endif %}
                                                </form>
                                                <a href="{{ url_for('edit_task', task_id=task.id) }}" class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <form method="POST" action="{{ url_for('delete_task', task_id=task.id) }}" class="d-inline">
                                                    <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Deletar task?')">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted text-center py-4">Nenhuma task registrada ainda.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Aba Airdrops -->
        <div class="tab-pane fade" id="airdrops" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Airdrops</h5>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addAirdropModal">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>
                <div class="card-body">
                    {% if protocol.airdrops %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Token</th>
                                        <th>Quantidade</th>
                                        <th>Preço/Token (USD)</th>
                                        <th>Total (USD)</th>
                                        <th>Status</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for airdrop in protocol.airdrops %}
                                        <tr>
                                            <td><strong>{{ airdrop.token_name }}</strong></td>
                                            <td>
                                                {% if airdrop.tokens_received %}
                                                    {{ "{:,.0f}".format(airdrop.tokens_received) }}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if airdrop.price_per_token %}
                                                    ${{ "{:.4f}".format(airdrop.price_per_token) }}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if airdrop.total_value_usd > 0 %}
                                                    <strong class="text-success">${{ "{:.2f}".format(airdrop.total_value_usd) }}</strong>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                                                {% if airdrop.status.value == 'pendente' %}
                                    <span class="badge bg-warning">Pending</span>
                                {% elif airdrop.status.value == 'recebido' %}
                                    <span class="badge bg-info">Received</span>
                                {% elif airdrop.status.value == 'vendido' %}
                                    <span class="badge bg-success">Sold</span>
                                {% endif %}
                                            </td>
                                            <td>
                                                {% if airdrop.received_date %}
                                                    {{ airdrop.received_date.strftime('%d/%m/%Y') }}
                                                {% elif airdrop.sold_date %}
                                                    {{ airdrop.sold_date.strftime('%d/%m/%Y') }}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{{ url_for('edit_airdrop', airdrop_id=airdrop.id) }}" class="btn btn-outline-warning btn-sm">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <form method="POST" action="{{ url_for('delete_airdrop', airdrop_id=airdrop.id) }}" class="d-inline">
                                                    <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Delete airdrop?')">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Resumo Total -->
                        {% set total_airdrops = protocol.get_total_airdrop_value() %}
                        {% if total_airdrops > 0 %}
                            <div class="alert alert-success mt-3">
                                <h6 class="mb-0">
                                    <i class="fas fa-trophy"></i> 
                                    Total Received from Airdrops: 
                                    <strong>${{ "{:.2f}".format(total_airdrops) }}</strong>
                                </h6>
                            </div>
                        {% endif %}
                    {% else %}
                        <p class="text-muted text-center py-4">No airdrops recorded yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Adicionar Airdrop -->
<div class="modal fade" id="addAirdropModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('add_airdrop', protocol_id=protocol.id) }}">
                <div class="modal-header">
                    <h5 class="modal-title">Add Airdrop</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="airdrop_token_name" class="form-label">Token Name</label>
                        <input type="text" class="form-control" id="airdrop_token_name" name="token_name" placeholder="Ex: ARB, OP, STRK" required>
                    </div>
                    <div class="mb-3">
                        <label for="airdrop_tokens_received" class="form-label">Tokens Received</label>
                        <input type="number" step="0.01" class="form-control" id="airdrop_tokens_received" name="tokens_received" placeholder="Ex: 1500">
                    </div>
                    <div class="mb-3">
                        <label for="airdrop_price_per_token" class="form-label">Price per Token (USD)</label>
                        <input type="number" step="0.0001" class="form-control" id="airdrop_price_per_token" name="price_per_token" placeholder="Ex: 1.25">
                    </div>
                    <div class="mb-3">
                        <label for="airdrop_status" class="form-label">Status</label>
                        <select class="form-select" id="airdrop_status" name="status" required>
                            <option value="pendente">Pending</option>
                            <option value="recebido">Received</option>
                            <option value="vendido">Sold</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="airdrop_received_date" class="form-label">Received Date</label>
                        <input type="date" class="form-control" id="airdrop_received_date" name="received_date">
                    </div>
                    <div class="mb-3">
                        <label for="airdrop_notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="airdrop_notes" name="notes" rows="2" placeholder="Additional notes..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal to Add Investment -->
<div class="modal fade" id="addInvestmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('add_investment', protocol_id=protocol.id) }}">
                <div class="modal-header">
                    <h5 class="modal-title">Add Investment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="investment_type" class="form-label">Type</label>
                        <select class="form-select" id="investment_type" name="type" required>
                            <option value="entrada">Entry</option>
                            <option value="retirada">Withdrawal</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="investment_amount" class="form-label">Amount (USD)</label>
                        <input type="number" step="0.01" class="form-control" id="investment_amount" name="amount" required>
                    </div>
                    <div class="mb-3">
                        <label for="investment_date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="investment_date" name="date" required>
                    </div>
                    <div class="mb-3">
                        <label for="investment_description" class="form-label">Description</label>
                        <textarea class="form-control" id="investment_description" name="description" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal to Add Task -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('add_task', protocol_id=protocol.id) }}">
                <div class="modal-header">
                    <h5 class="modal-title">Add Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="task_title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="task_title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="task_description" class="form-label">Description</label>
                        <textarea class="form-control" id="task_description" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %} 